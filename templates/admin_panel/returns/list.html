{% extends 'admin_panel/base.html' %}

{% block title %}İade Talepleri{% endblock %}

{% block page_title %}
<div class="flex items-center gap-3">
    <div class="w-10 h-10 bg-gradient-to-br from-red-400 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z"></path>
        </svg>
    </div>
    <div>
        <h1 class="text-2xl font-black text-gray-900">İade Talepleri</h1>
        <p class="text-sm text-gray-500 font-medium">Müşteri iade taleplerini yönetin</p>
    </div>
</div>
{% endblock %}

{% block content %}

<section class="space-y-6" x-data="{ 
             selectedItems: [],
             selectAll: false,
             allIds: [{% for r in page_obj %}'{{ r.id }}'{% if not forloop.last %},{% endif %}{% endfor %}],
             toggleAll() {
                 if (this.selectAll) {
                     this.selectedItems = [...this.allIds];
                 } else {
                     this.selectedItems = [];
                 }
             },
             toggleItem(id) {
                 const index = this.selectedItems.indexOf(id);
                 if (index > -1) {
                     this.selectedItems.splice(index, 1);
                 } else {
                     this.selectedItems.push(id);
                 }
             }
         }">

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <!-- Toplam İade -->
        {% include 'admin_panel/components/stats_card.html' with label='Toplam İade' value=stats.total color='blue' sub_label='Tüm zamanlar' icon='<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z"></path></svg>' %}
        
        <!-- Bekleyen -->
        {% include 'admin_panel/components/stats_card.html' with label='Bekleyen' value=stats.pending color='yellow' sub_label='Onay bekleyen' icon='<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' %}
        
        <!-- Onaylanan -->
        {% include 'admin_panel/components/stats_card.html' with label='Onaylanan' value=stats.approved color='green' sub_label='İşlemde olan' icon='<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' %}
        
        <!-- Reddedilen -->
        {% include 'admin_panel/components/stats_card.html' with label='Reddedilen' value=stats.rejected color='red' sub_label='İptal edilen' icon='<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' %}
    </div>

    <!-- Bulk Actions Bar -->
    <div x-show="selectedItems.length > 0" x-transition x-cloak
        class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
        <div class="glass-card rounded-2xl shadow-2xl px-6 py-4 flex items-center gap-4">
            <span class="text-sm font-semibold text-gray-900">
                <span x-text="selectedItems.length"></span> talep seçildi
            </span>
            
            <form hx-post="{% url 'admin_return_bulk_action' %}" hx-swap="none" class="contents">
                {% csrf_token %}
                <input type="hidden" name="action" value="approved">
                <template x-for="id in selectedItems" :key="id">
                    <input type="hidden" name="selected_items" :value="id">
                </template>
                {% include 'admin_panel/components/button.html' with label='Onayla' variant='success' size='sm' type='submit' %}
            </form>
            
            <form hx-post="{% url 'admin_return_bulk_action' %}" hx-swap="none" class="contents">
                {% csrf_token %}
                <input type="hidden" name="action" value="rejected">
                <template x-for="id in selectedItems" :key="id">
                    <input type="hidden" name="selected_items" :value="id">
                </template>
                {% include 'admin_panel/components/button.html' with label='Reddet' variant='danger' size='sm' type='submit' %}
            </form>
            
            <form hx-post="{% url 'admin_return_bulk_action' %}" hx-swap="none" class="contents">
                {% csrf_token %}
                <input type="hidden" name="action" value="completed">
                <template x-for="id in selectedItems" :key="id">
                    <input type="hidden" name="selected_items" :value="id">
                </template>
                {% include 'admin_panel/components/button.html' with label='Tamamla' variant='primary' size='sm' type='submit' %}
            </form>
            
            <form hx-post="{% url 'admin_return_bulk_action' %}" hx-swap="none" class="contents">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <template x-for="id in selectedItems" :key="id">
                    <input type="hidden" name="selected_items" :value="id">
                </template>
                {% include 'admin_panel/components/button.html' with label='Sil' variant='secondary' size='sm' type='submit' %}
            </form>
            
            <button @click="selectedItems = []; selectAll = false"
                class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 font-medium transition-colors">
                İptal
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-3">
        <form method="GET" class="space-y-3">
            <!-- Search Bar -->
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text" name="search" value="{{ search }}" 
                    placeholder="Sipariş no, müşteri adı, telefon veya iade ID..."
                    class="block w-full pl-9 pr-3 py-2 bg-gray-50 border-gray-200 rounded-lg text-sm text-gray-900 placeholder-gray-400 focus:bg-white focus:ring-1 focus:ring-primary focus:border-primary transition-all">
                {% if search %}
                <div class="absolute inset-y-0 right-0 pr-2 flex items-center">
                    <a href="{% url 'admin_returns' %}" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Modern Status Pills -->
            <div class="flex flex-wrap items-center gap-2 mb-4">
                <a href="?{% for key, value in request.GET.items %}{% if key != 'status' %}{{ key }}={{ value }}&{% endif %}{% endfor %}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all {% if not status %}bg-primary text-white shadow-sm{% else %}bg-white text-gray-600 border border-gray-200 hover:border-gray-300 hover:shadow-sm{% endif %}">
                    Tümü
                    <span class="{% if not status %}bg-white/20 text-white{% else %}bg-gray-100 text-gray-700{% endif %} px-2 py-0.5 rounded-md text-xs font-bold">{{ stats.total }}</span>
                </a>
                
                {% for code, label, count in status_choices %}
                <a href="?status={{ code }}{% for key, value in request.GET.items %}{% if key != 'status' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all
                   {% if status == code %}
                       {% if code == 'pending' %}bg-yellow-500 text-white shadow-sm
                       {% elif code == 'approved' %}bg-green-500 text-white shadow-sm
                       {% elif code == 'rejected' %}bg-red-500 text-white shadow-sm
                       {% elif code == 'completed' %}bg-blue-500 text-white shadow-sm
                       {% else %}bg-gray-700 text-white shadow-sm{% endif %}
                   {% else %}
                       bg-white text-gray-600 border border-gray-200 hover:border-gray-300 hover:shadow-sm
                   {% endif %}">
                    {{ label }}
                    <span class="{% if status == code %}bg-white/20 text-white{% else %}bg-gray-100 text-gray-700{% endif %} px-2 py-0.5 rounded-md text-xs font-bold">{{ count }}</span>
                </a>
                {% endfor %}
                
                <!-- Clear All Filters -->
                <div class="ml-auto">
                    {% url 'admin_returns' as returns_url %}
                    <a href="{{ returns_url }}" 
                       class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-600 border border-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-200 hover:border-gray-300 transition-all" 
                       title="Tüm Filtreleri Temizle">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Temizle
                    </a>
                </div>
            </div>

            <!-- Compact Filters Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                
                <!-- Date Range Picker -->
                <div class="col-span-2 lg:col-span-2 relative" x-data="{
                    isOpen: false,
                    start: '{{ date_from|default:'' }}',
                    end: '{{ date_to|default:'' }}',
                    label: 'Tarih Aralığı',
                    presets: [
                        { label: 'Bugün', days: 0 },
                        { label: 'Dün', days: 1 },
                        { label: 'Son 7 Gün', days: 7 },
                        { label: 'Son 30 Gün', days: 30 },
                        { label: 'Bu Ay', type: 'month' },
                        { label: 'Geçen Ay', type: 'last_month' },
                        { label: 'Tüm Zamanlar', type: 'all' }
                    ],
                    init() {
                        this.updateLabel();
                    },
                    updateLabel() {
                        if (this.start && this.end) {
                            const formatDate = (d) => {
                                const [y, m, d_] = d.split('-');
                                return `${d_}.${m}.${y}`;
                            };
                            this.label = `${formatDate(this.start)} - ${formatDate(this.end)}`;
                        } else {
                            this.label = 'Tarih Aralığı';
                        }
                    },
                    applyPreset(preset) {
                        const today = new Date();
                        let start = new Date();
                        let end = new Date();

                        if (preset.type === 'all') {
                            this.start = '';
                            this.end = '';
                        } else if (preset.type === 'month') {
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                            end = today;
                        } else if (preset.type === 'last_month') {
                            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            end = new Date(today.getFullYear(), today.getMonth(), 0);
                        } else if (preset.label === 'Dün') {
                            start.setDate(today.getDate() - 1);
                            end.setDate(today.getDate() - 1);
                        } else {
                            start.setDate(today.getDate() - preset.days + (preset.days === 0 ? 0 : 1));
                        }

                        if (preset.type !== 'all') {
                            this.start = start.toISOString().split('T')[0];
                            this.end = end.toISOString().split('T')[0];
                        }

                        // Update hidden inputs and submit
                        this.$refs.dateFrom.value = this.start;
                        this.$refs.dateTo.value = this.end;
                        this.$el.closest('form').submit();
                    },
                    applyCustom() {
                        this.$refs.dateFrom.value = this.start;
                        this.$refs.dateTo.value = this.end;
                        this.$el.closest('form').submit();
                    }
                }" @click.away="isOpen = false">
                    
                    <!-- Hidden Inputs -->
                    <input type="hidden" name="date_from" x-ref="dateFrom" value="{{ date_from|default:'' }}">
                    <input type="hidden" name="date_to" x-ref="dateTo" value="{{ date_to|default:'' }}">

                    <!-- Trigger Button -->
                    <button type="button" @click="isOpen = !isOpen"
                        class="w-full flex items-center justify-between rounded-lg border border-gray-200 bg-white text-sm py-2 px-3 hover:bg-gray-50 focus:ring-1 focus:ring-primary focus:border-primary transition-colors">
                        <span class="flex items-center gap-2 text-gray-700 truncate">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span x-text="label"></span>
                        </span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <!-- Dropdown Panel -->
                    <div x-show="isOpen" x-transition.origin.top.left
                        class="absolute z-50 top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden">
                        <div class="flex flex-col">
                            <!-- Presets -->
                            <div class="p-2 border-b border-gray-100 bg-gray-50/50 grid grid-cols-2 gap-1">
                                <template x-for="preset in presets">
                                    <button type="button" @click="applyPreset(preset)"
                                        class="text-left px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-white hover:text-primary hover:shadow-sm rounded-lg transition-all">
                                        <span x-text="preset.label"></span>
                                    </button>
                                </template>
                            </div>

                            <!-- Custom Range -->
                            <div class="p-3 space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Başlangıç</label>
                                        <input type="date" x-model="start"
                                            class="w-full rounded-lg border-gray-200 text-xs py-1.5 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Bitiş</label>
                                        <input type="date" x-model="end"
                                            class="w-full rounded-lg border-gray-200 text-xs py-1.5 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                                    </div>
                                </div>
                                <button type="button" @click="applyCustom()"
                                    class="w-full py-2 text-xs font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors shadow-sm shadow-primary/30">
                                    Uygula
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Per Page -->
                <div class="col-span-1 lg:col-span-1">
                    <select name="per_page" onchange="this.form.submit()"
                        class="w-full rounded-lg border-gray-200 text-sm py-2 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                        {% for size in per_page_options %}
                        <option value="{{ size }}" {% if per_page == size %}selected{% endif %}>{{ size }} / Sayfa</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <!-- Top Actions -->
    <div class="flex items-center justify-between">
        <p class="text-sm text-gray-600">
            <span class="font-semibold text-gray-900">{{ page_obj.paginator.count }}</span> iade talebi bulundu
        </p>
    </div>

    <!-- Returns Table -->
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-100">
                <thead class="bg-gray-50 text-[11px] font-semibold uppercase tracking-wide text-gray-500">
                    <tr>
                        <th class="px-4 py-3 w-12">
                            <input type="checkbox" x-model="selectAll" @change="toggleAll()"
                                class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary">
                        </th>
                        {% include 'admin_panel/orders/partials/sort_header.html' with label='Talep ID' column='id' align='left' %}
                        {% include 'admin_panel/orders/partials/sort_header.html' with label='Sipariş' column='order' align='left' %}
                        {% include 'admin_panel/orders/partials/sort_header.html' with label='Müşteri' column='customer' align='left' %}
                        {% include 'admin_panel/orders/partials/sort_header.html' with label='Neden' column='reason' align='left' %}
                        {% include 'admin_panel/orders/partials/sort_header.html' with label='Durum' column='status' align='center' %}
                        {% include 'admin_panel/orders/partials/sort_header.html' with label='Tarih' column='created_at' align='center' %}
                        <th class="px-4 py-3 text-center">İşlemler</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 text-sm">
                    {% for return_req in page_obj %}
                    <tr class="hover:bg-gray-50/50 transition-colors group">
                        <td class="px-4 py-3">
                            <input type="checkbox" :value="'{{ return_req.id }}'" x-model="selectedItems"
                                class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary">
                        </td>
                        <td class="px-4 py-3 font-medium text-gray-900">#{{ return_req.id }}</td>
                        <td class="px-4 py-3">
                            <a href="{% url 'admin_order_detail' return_req.order.id %}" 
                               hx-get="{% url 'admin_order_detail' return_req.order.id %}"
                               hx-target="#modal-container"
                               hx-swap="innerHTML"
                               class="text-blue-600 hover:underline cursor-pointer">
                                #{{ return_req.order.id }}
                            </a>
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">{{ return_req.order.customer_name }}</div>
                            <div class="text-xs text-gray-500">{{ return_req.order.phone }}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-sm text-gray-700">{{ return_req.get_reason_display }}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if return_req.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif return_req.status == 'approved' %}bg-green-100 text-green-800
                                {% elif return_req.status == 'rejected' %}bg-red-100 text-red-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ return_req.get_status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center text-gray-500">
                            {{ return_req.created_at|date:"d.m.Y H:i" }}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button hx-get="{% url 'admin_return_detail' return_req.id %}"
                                    hx-target="#modal-container"
                                    hx-swap="innerHTML"
                                    class="text-gray-400 hover:text-blue-600 transition-colors p-2 hover:bg-blue-50 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                            Filtre kriterlerine uyan iade talebi bulunamadı.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="flex flex-col md:flex-row items-center justify-between gap-3 px-4 py-4 border-t border-gray-100 text-sm">
            <p class="text-gray-500">
                {{ page_obj.paginator.count }} kayıttan
                <span class="font-semibold text-gray-900">
                    {{ page_obj.start_index }} - {{ page_obj.end_index }}
                </span>
                arası gösteriliyor.
            </p>
            <div class="flex items-center gap-2">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&sort={{ sort }}&dir={{ direction }}{{ query_string }}"
                    class="px-3 py-1.5 rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-100">Önceki</a>
                {% else %}
                <span class="px-3 py-1.5 rounded-xl border border-gray-100 text-gray-300">Önceki</span>
                {% endif %}

                <span class="px-3 py-1.5 rounded-xl bg-gray-100 text-gray-700 font-semibold">
                    Sayfa {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&sort={{ sort }}&dir={{ direction }}{{ query_string }}"
                    class="px-3 py-1.5 rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-100">Sonraki</a>
                {% else %}
                <span class="px-3 py-1.5 rounded-xl border border-gray-100 text-gray-300">Sonraki</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Modal Container for HTMX -->
<div id="modal-container"></div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Modal success handler
    document.body.addEventListener('modalSuccess', () => {
        // Close modal
        document.getElementById('modal-container').innerHTML = '';
        // Reload page
        window.location.reload();
    });
</script>
{% endblock %}
