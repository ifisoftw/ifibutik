{% extends 'admin_panel/base.html' %}

{% block title %}Raporlar{% endblock %}
{% block page_title %}
<div class="flex items-center gap-3">
    <div class="w-10 h-10 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
    </div>
    <div>
        <h1 class="text-2xl font-black text-gray-900">Raporlar</h1>
        <p class="text-sm text-gray-500 font-medium">Detaylı analiz ve raporlar</p>
    </div>
</div>
{% endblock %}

{% block content %}

<div x-data="{ activeTab: 'general' }">
    <!-- Tab Navigation -->
    <div class="mb-6 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button @click="activeTab = 'general'"
                :class="activeTab === 'general' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                Genel Raporlar
            </button>
            <button @click="activeTab = 'profitability'"
                :class="activeTab === 'profitability' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                Karlılık Raporları
            </button>
        </nav>
    </div>

    <!-- General Tab Content -->
    <div x-show="activeTab === 'general'" x-transition.opacity>
        <div class="mb-6 bg-white border border-gray-200 rounded-xl shadow-sm p-3">
            <form method="GET" class="flex flex-col md:flex-row items-center gap-3">
                <!-- Date Range Picker -->
                <div class="w-full md:w-72 relative" x-data="{
                    isOpen: false,
                    start: '{{ start_date|date:'Y-m-d'|default:'' }}',
                    end: '{{ end_date|date:'Y-m-d'|default:'' }}',
                    label: 'Tarih Aralığı',
                    presets: [
                        { label: 'Bugün', days: 0 },
                        { label: 'Dün', days: 1 },
                        { label: 'Son 7 Gün', days: 7 },
                        { label: 'Son 30 Gün', days: 30 },
                        { label: 'Bu Ay', type: 'month' },
                        { label: 'Geçen Ay', type: 'last_month' },
                        { label: 'Tüm Zamanlar', type: 'all' }
                    ],
                    init() {
                        this.updateLabel();
                    },
                    updateLabel() {
                        if (this.start && this.end) {
                            const formatDate = (d) => {
                                const [y, m, d_] = d.split('-');
                                return `${d_}.${m}.${y}`;
                            };
                            this.label = `${formatDate(this.start)} - ${formatDate(this.end)}`;
                        } else {
                            this.label = 'Tarih Aralığı';
                        }
                    },
                    applyPreset(preset) {
                        const today = new Date();
                        let start = new Date();
                        let end = new Date();
        
                        if (preset.type === 'all') {
                            this.start = '';
                            this.end = '';
                        } else if (preset.type === 'month') {
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                            end = today;
                        } else if (preset.type === 'last_month') {
                            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            end = new Date(today.getFullYear(), today.getMonth(), 0);
                        } else if (preset.label === 'Dün') {
                            start.setDate(today.getDate() - 1);
                            end.setDate(today.getDate() - 1);
                        } else {
                            start.setDate(today.getDate() - preset.days + (preset.days === 0 ? 0 : 1));
                        }
        
                        if (preset.type !== 'all') {
                            this.start = start.toISOString().split('T')[0];
                            this.end = end.toISOString().split('T')[0];
                        }
        
                        // Update hidden inputs and submit
                        this.$refs.startDate.value = this.start;
                        this.$refs.endDate.value = this.end;
                        this.$el.closest('form').submit();
                    },
                    applyCustom() {
                        this.$refs.startDate.value = this.start;
                        this.$refs.endDate.value = this.end;
                        this.$el.closest('form').submit();
                    }
                }" @click.away="isOpen = false">
                    
                    <!-- Hidden Inputs -->
                    <input type="hidden" name="start_date" x-ref="startDate" value="{{ start_date|date:'Y-m-d'|default:'' }}">
                    <input type="hidden" name="end_date" x-ref="endDate" value="{{ end_date|date:'Y-m-d'|default:'' }}">
        
                    <!-- Trigger Button -->
                    <button type="button" @click="isOpen = !isOpen"
                        class="w-full flex items-center justify-between rounded-lg border border-gray-200 bg-white text-sm py-2 px-3 hover:bg-gray-50 focus:ring-1 focus:ring-primary focus:border-primary transition-colors">
                        <span class="flex items-center gap-2 text-gray-700 truncate">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span x-text="label"></span>
                        </span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
        
                    <!-- Dropdown Panel -->
                    <div x-show="isOpen" x-transition.origin.top.left
                        class="absolute z-50 top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden">
                        <div class="flex flex-col">
                            <!-- Presets -->
                            <div class="p-2 border-b border-gray-100 bg-gray-50/50 grid grid-cols-2 gap-1">
                                <template x-for="preset in presets">
                                    <button type="button" @click="applyPreset(preset)"
                                        class="text-left px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-white hover:text-primary hover:shadow-sm rounded-lg transition-all">
                                        <span x-text="preset.label"></span>
                                    </button>
                                </template>
                            </div>
        
                            <!-- Custom Range -->
                            <div class="p-3 space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Başlangıç</label>
                                        <input type="date" x-model="start"
                                            class="w-full rounded-lg border-gray-200 text-xs py-1.5 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Bitiş</label>
                                        <input type="date" x-model="end"
                                            class="w-full rounded-lg border-gray-200 text-xs py-1.5 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                                    </div>
                                </div>
                                <button type="button" @click="applyCustom()"
                                    class="w-full py-2 text-xs font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors shadow-sm shadow-primary/30">
                                    Uygula
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="flex-1"></div>
        
                <a href="{% url 'admin_reports_export' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" 
                   class="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 rounded-lg text-sm font-medium transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Excel İndir
                </a>
            </form>
        </div>
        
        
        <!-- Revenue Chart & Product Performance -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Revenue Chart -->
            <div class="lg:col-span-2 glass-card rounded-2xl p-6 h-[450px]">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">Ciro Grafiği</h2>
                        <p class="text-sm text-gray-500" id="chart-subtitle">Seçilen tarih aralığına göre günlük ciro</p>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button onclick="updateChart('daily')" id="btn-daily" 
                                class="px-3 py-1.5 text-xs font-semibold rounded-md transition-all shadow-sm bg-white text-gray-900">
                            Günlük
                        </button>
                        <button onclick="updateChart('cumulative')" id="btn-cumulative" 
                                class="px-3 py-1.5 text-xs font-semibold rounded-md transition-all text-gray-500 hover:text-gray-900">
                            Kümülatif
                        </button>
                    </div>
                </div>
                <div id="revenue-chart"></div>
            </div>

            <!-- Product Performance -->
            <div class="glass-card rounded-2xl flex flex-col h-[450px]">
                <div class="px-6 py-4 border-b border-gray-200 flex-none">
                    <h2 class="text-lg font-bold text-gray-900">Ürün Performansı</h2>
                    <p class="text-sm text-gray-500">En çok satan ürünler</p>
                </div>
                <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                    <div class="space-y-3">
                        {% for product in top_products %}
                        <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                            <div class="flex items-center gap-3">
                                {% if product.images.first %}
                                <img src="{{ product.images.first.image.url }}" class="w-10 h-10 object-cover rounded-lg">
                                {% else %}
                                <div class="w-10 h-10 bg-gray-100 rounded-lg"></div>
                                {% endif %}
                                <div>
                                    <p class="font-semibold text-gray-900 text-sm line-clamp-1">{{ product.name }}</p>
                                    <p class="text-xs text-gray-500">{{ product.sku }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-gray-900">{{ product.sales_count }}</p>
                                <p class="text-xs text-gray-500">Adet</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-400 py-8">Veri bulunamadı</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl" x-data="{ sortBy: 'count' }">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">Kampanya Bazlı Rapor</h2>
                        <p class="text-sm text-gray-500">Seçilen tarih aralığına göre</p>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button @click="sortBy = 'count'" 
                                :class="sortBy === 'count' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'"
                                class="px-3 py-1.5 text-xs font-semibold rounded-md transition-all">
                            Sipariş
                        </button>
                        <button @click="sortBy = 'revenue'" 
                                :class="sortBy === 'revenue' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'"
                                class="px-3 py-1.5 text-xs font-semibold rounded-md transition-all">
                            Ciro
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Sort by Count -->
                    <div x-show="sortBy === 'count'" class="space-y-3">
                        {% for item in campaign_report %}
                        <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:border-primary transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-brand-pink to-brand-purple rounded-lg flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">{{ forloop.counter }}</span>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900 text-sm">{{ item.campaign__title }}</p>
                                    <p class="text-xs text-gray-500">₺{{ item.total_revenue|floatformat:0 }} Ciro</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-gray-900">{{ item.order_count }}</p>
                                <p class="text-xs text-gray-500">Sipariş</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-400 py-8">Veri bulunamadı</p>
                        {% endfor %}
                    </div>

                    <!-- Sort by Revenue -->
                    <div x-show="sortBy === 'revenue'" class="space-y-3" style="display: none;">
                        {% for item in campaign_report_revenue %}
                        <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:border-primary transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">{{ forloop.counter }}</span>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900 text-sm">{{ item.campaign__title }}</p>
                                    <p class="text-xs text-gray-500">{{ item.order_count }} Sipariş</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-gray-900">₺{{ item.total_revenue|floatformat:0 }}</p>
                                <p class="text-xs text-gray-500">Ciro</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-400 py-8">Veri bulunamadı</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-2xl" x-data="{ sortBy: 'count' }">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">Şehir Bazlı Rapor</h2>
                        <p class="text-sm text-gray-500">Seçilen tarih aralığına göre</p>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button @click="sortBy = 'count'" 
                                :class="sortBy === 'count' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'"
                                class="px-3 py-1.5 text-xs font-semibold rounded-md transition-all">
                            Sipariş
                        </button>
                        <button @click="sortBy = 'revenue'" 
                                :class="sortBy === 'revenue' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'"
                                class="px-3 py-1.5 text-xs font-semibold rounded-md transition-all">
                            Ciro
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Sort by Count -->
                    <div x-show="sortBy === 'count'" class="space-y-3">
                        {% for item in city_report %}
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-900">{{ item.city_fk__name }}</span>
                                    <span class="text-sm font-bold text-gray-900">{{ item.order_count }} sipariş</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    {% widthratio item.order_count city_report.0.order_count 100 as percent %}
                                    <div class="bg-gradient-to-r from-brand-pink to-brand-purple h-2 rounded-full" style="width: {{ percent }}%"></div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-400 py-8">Veri bulunamadı</p>
                        {% endfor %}
                    </div>

                    <!-- Sort by Revenue -->
                    <div x-show="sortBy === 'revenue'" class="space-y-3" style="display: none;">
                        {% for item in city_report_revenue %}
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-900">{{ item.city_fk__name }}</span>
                                    <span class="text-sm font-bold text-gray-900">₺{{ item.total_revenue|floatformat:0 }}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    {% widthratio item.total_revenue city_report_revenue.0.total_revenue 100 as percent %}
                                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full" style="width: {{ percent }}%"></div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-400 py-8">Veri bulunamadı</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profitability Tab Content -->
    <div x-show="activeTab === 'profitability'" x-transition.opacity x-cloak>
        <!-- Input Form -->
        <div class="mb-6 bg-white border border-gray-200 rounded-xl shadow-sm p-4">
            <form method="GET" class="flex flex-col md:flex-row items-end gap-4" @submit.prevent="updateProfitability">
                <!-- Preserve Date Filters -->
                <input type="hidden" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                <input type="hidden" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
                
                <div class="w-full md:w-1/4">
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Kargo Gidiş Ücreti</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₺</span>
                        <input type="number" step="0.01" name="shipping_cost" value="{{ profitability_data.shipping_cost|stringformat:'s' }}" required
                            class="w-full pl-7 rounded-lg border-gray-200 focus:ring-primary focus:border-primary">
                    </div>
                </div>

                <div class="w-full md:w-1/4">
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Müşteri İade Ücreti</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₺</span>
                        <input type="number" step="0.01" name="return_cost" value="{{ profitability_data.return_cost|stringformat:'s' }}" required
                            class="w-full pl-7 rounded-lg border-gray-200 focus:ring-primary focus:border-primary">
                    </div>
                </div>

                <div class="w-full md:w-1/4">
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Teslim Olmayan Ücreti</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">₺</span>
                        <input type="number" step="0.01" name="undelivered_cost" value="{{ profitability_data.undelivered_cost|stringformat:'s' }}" required
                            class="w-full pl-7 rounded-lg border-gray-200 focus:ring-primary focus:border-primary">
                    </div>
                </div>

                <div class="w-full md:w-auto">
                    <button type="submit" class="w-full px-6 py-2.5 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors shadow-sm shadow-primary/30">
                        Hesapla
                    </button>
                </div>
            </form>
        </div>

        <div id="profitability-results">
        {% if profitability_data %}
        <!-- Summary Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            {% include 'admin_panel/components/stats_card.html' with label="Net Ciro" value=profitability_data.amount_kept|floatformat:0|add:" ₺" color="green" icon="currency-lira" sub_label="Teslim Edilen (İade Olmayan)" %}
            
            {% include 'admin_panel/components/stats_card.html' with label="Toplam Kargo Gideri" value=profitability_data.cost_grand_total|floatformat:0|add:" ₺" color="red" icon="truck" sub_label="Tüm Operasyonel Maliyetler" %}
            
            {% include 'admin_panel/components/stats_card.html' with label="Net Kar (Operasyonel)" value=profitability_data.net_profit|floatformat:0|add:" ₺" color="blue" icon="chart-bar" sub_label="Ciro - Kargo Gideri" %}
            
            {% include 'admin_panel/components/stats_card.html' with label="Beklenen Max Kar" value=profitability_data.expected_max_profit|floatformat:0|add:" ₺" color="purple" icon="check-circle" sub_label="Mevcut + Yolda Olanlar" %}
        </div>
        
        <!-- Profitability Table -->
        <div class="glass-card rounded-2xl overflow-hidden mb-6">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-4 font-bold"></th>
                            <th scope="col" class="px-6 py-4 font-bold text-center">
                                Çıkış Yapılan Kargo<br>
                                <span class="text-[10px] font-normal text-gray-400 normal-case">(Tüm Siparişler)</span>
                            </th>
                            <th scope="col" class="px-6 py-4 font-bold text-center">
                                Yolda<br>
                                <span class="text-[10px] font-normal text-gray-400 normal-case">(Teslimat Sürecinde)</span>
                            </th>
                            <th scope="col" class="px-6 py-4 font-bold text-center">
                                Teslim<br>
                                <span class="text-[10px] font-normal text-gray-400 normal-case">(Teslim Edilen)</span>
                            </th>
                            <th scope="col" class="px-6 py-4 font-bold text-center">
                                Teslim Olmayan<br>
                                <span class="text-[10px] font-normal text-gray-400 normal-case">(İptal/Sorunlu)</span>
                            </th>
                            <th scope="col" class="px-6 py-4 font-bold text-center">
                                Müşteriden İade<br>
                                <span class="text-[10px] font-normal text-gray-400 normal-case">(İade Edilen)</span>
                            </th>
                            <th scope="col" class="px-6 py-4 font-bold text-center bg-gray-50 border-l border-gray-200">
                                Teslim Edilen İade Olmayan<br>
                                <span class="text-[10px] font-normal text-gray-400 normal-case">(Net Kalan)</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Adet Row -->
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <th scope="row" class="px-6 py-4 font-bold text-gray-900 whitespace-nowrap">Adet</th>
                            <td class="px-6 py-4 text-center font-medium">{{ profitability_data.count_total }}</td>
                            <td class="px-6 py-4 text-center font-medium">{{ profitability_data.count_shipped }}</td>
                            <td class="px-6 py-4 text-center font-medium">{{ profitability_data.count_delivered_initial }}</td>
                            <td class="px-6 py-4 text-center font-medium">{{ profitability_data.count_undelivered }}</td>
                            <td class="px-6 py-4 text-center font-medium">{{ profitability_data.count_return }}</td>
                            <td class="px-6 py-4 text-center font-medium bg-gray-50 border-l border-gray-200">{{ profitability_data.count_kept }}</td>
                        </tr>
                        <!-- Tutar Row -->
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <th scope="row" class="px-6 py-4 font-bold text-gray-900 whitespace-nowrap">Tutar</th>
                            <td class="px-6 py-4 text-center">₺{{ profitability_data.amount_total|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center">₺{{ profitability_data.amount_shipped|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center">₺{{ profitability_data.amount_delivered_initial|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center">₺{{ profitability_data.amount_undelivered|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center">₺{{ profitability_data.amount_return|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center bg-gray-50 border-l border-gray-200">₺{{ profitability_data.amount_kept|floatformat:0 }}</td>
                        </tr>
                        <!-- Maliyet Row -->
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <th scope="row" class="px-6 py-4 font-bold text-gray-900 whitespace-nowrap">Maliyet</th>
                            <td class="px-6 py-4 text-center text-red-600 font-medium">₺{{ profitability_data.cost_total|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center text-red-600 font-medium">₺{{ profitability_data.cost_shipped|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center text-red-600 font-medium">₺{{ profitability_data.cost_delivered_initial|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center text-red-600 font-medium">₺{{ profitability_data.cost_undelivered|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center text-red-600 font-medium">₺{{ profitability_data.cost_return|floatformat:0 }}</td>
                            <td class="px-6 py-4 text-center text-red-600 font-medium bg-gray-50 border-l border-gray-200">₺{{ profitability_data.cost_kept|floatformat:0 }}</td>
                        </tr>
                        <!-- Oran Row -->
                        <tr class="bg-white hover:bg-gray-50">
                            <th scope="row" class="px-6 py-4 font-bold text-gray-900 whitespace-nowrap">Oran</th>
                            <td class="px-6 py-4 text-center font-bold text-blue-600">100%</td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600">%{{ profitability_data.rate_shipped|floatformat:1 }}</td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600">%{{ profitability_data.rate_delivered_initial|floatformat:1 }}</td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600">%{{ profitability_data.rate_undelivered|floatformat:1 }}</td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600">%{{ profitability_data.rate_return|floatformat:1 }}</td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600 bg-gray-50 border-l border-gray-200">%{{ profitability_data.rate_kept|floatformat:1 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        </div>
        </div>
    </div>
</div>

<script>
    function updateProfitability(e) {
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerText;
        
        // Loading state
        submitBtn.disabled = true;
        submitBtn.innerText = 'Hesaplanıyor...';
        submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        const url = `${window.location.pathname}?${params.toString()}`;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.getElementById('profitability-results').innerHTML;
                document.getElementById('profitability-results').innerHTML = newContent;
                
                // Update URL without reload
                window.history.pushState({}, '', url);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            })
            .finally(() => {
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            });
    }
</script>

{% endblock %}

{% block extra_scripts %}
<script>
    // Chart Configuration
    const chartData = {{ chart_data|safe }};
    
    // Base options
    const baseOptions = {
        chart: {
            type: 'area',
            height: 350,
            toolbar: { show: false },
            zoom: { enabled: false },
            fontFamily: 'Inter, sans-serif',
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        xaxis: {
            categories: chartData.labels,
            labels: {
                style: { fontSize: '10px', colors: '#6B7280' }
            },
            axisBorder: { show: true, color: '#E5E7EB' },
            axisTicks: { show: false }
        },
        yaxis: {
            labels: {
                formatter: function(value) {
                    return value >= 1000 ? '₺' + (value / 1000).toFixed(1) + 'k' : '₺' + value.toFixed(0);
                },
                style: { fontSize: '11px', colors: '#6B7280' }
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.2,
                stops: [0, 90, 100]
            }
        },
        dataLabels: { enabled: false },
        tooltip: {
            y: {
                formatter: function(value) {
                    return '₺' + value.toFixed(2);
                }
            }
        }
    };

    // Initialize Chart
    const chart = new ApexCharts(document.querySelector("#revenue-chart"), {
        ...baseOptions,
        series: [{
            name: 'Ciro',
            data: chartData.revenue
        }],
        colors: ['#8B5CF6']
    });
    chart.render();

    // Toggle Function
    function updateChart(type) {
        const btnDaily = document.getElementById('btn-daily');
        const btnCumulative = document.getElementById('btn-cumulative');
        const subtitle = document.getElementById('chart-subtitle');

        // Reset buttons
        const activeClass = "bg-white text-gray-900 shadow-sm";
        const inactiveClass = "text-gray-500 hover:text-gray-900";
        
        btnDaily.className = "px-3 py-1.5 text-xs font-semibold rounded-md transition-all " + inactiveClass;
        btnCumulative.className = "px-3 py-1.5 text-xs font-semibold rounded-md transition-all " + inactiveClass;

        if (type === 'daily') {
            btnDaily.className = "px-3 py-1.5 text-xs font-semibold rounded-md transition-all " + activeClass;
            subtitle.textContent = "Seçilen tarih aralığına göre günlük ciro";
            
            chart.updateOptions({
                series: [{
                    name: 'Ciro',
                    data: chartData.revenue
                }],
                colors: ['#8B5CF6']
            });
        } else {
            btnCumulative.className = "px-3 py-1.5 text-xs font-semibold rounded-md transition-all " + activeClass;
            subtitle.textContent = "Seçilen tarih aralığına göre kümülatif ciro";
            
            chart.updateOptions({
                series: [{
                    name: 'Kümülatif Ciro',
                    data: chartData.revenue_cumulative
                }],
                colors: ['#10B981']
            });
        }
    }
</script>
{% endblock %}

