{% extends 'admin_panel/base.html' %}

{% block title %}Raporlar{% endblock %}
{% block page_title %}
<div class="flex items-center gap-3">
    <div class="w-10 h-10 bg-gradient-to-br from-teal-400 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
    </div>
    <div>
        <h1 class="text-2xl font-black text-gray-900">Raporlar</h1>
        <p class="text-sm text-gray-500 font-medium">Detaylı analiz ve raporlar</p>
    </div>
</div>
{% endblock %}

{% block content %}

<div class="mb-6 bg-white border border-gray-200 rounded-xl shadow-sm p-3">
    <form method="GET" class="flex flex-col md:flex-row items-center gap-3">
        <!-- Date Range Picker -->
        <div class="w-full md:w-72 relative" x-data="{
            isOpen: false,
            start: '{{ start_date|date:'Y-m-d'|default:'' }}',
            end: '{{ end_date|date:'Y-m-d'|default:'' }}',
            label: 'Tarih Aralığı',
            presets: [
                { label: 'Bugün', days: 0 },
                { label: 'Dün', days: 1 },
                { label: 'Son 7 Gün', days: 7 },
                { label: 'Son 30 Gün', days: 30 },
                { label: 'Bu Ay', type: 'month' },
                { label: 'Geçen Ay', type: 'last_month' },
                { label: 'Tüm Zamanlar', type: 'all' }
            ],
            init() {
                this.updateLabel();
            },
            updateLabel() {
                if (this.start && this.end) {
                    const formatDate = (d) => {
                        const [y, m, d_] = d.split('-');
                        return `${d_}.${m}.${y}`;
                    };
                    this.label = `${formatDate(this.start)} - ${formatDate(this.end)}`;
                } else {
                    this.label = 'Tarih Aralığı';
                }
            },
            applyPreset(preset) {
                const today = new Date();
                let start = new Date();
                let end = new Date();

                if (preset.type === 'all') {
                    this.start = '';
                    this.end = '';
                } else if (preset.type === 'month') {
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = today;
                } else if (preset.type === 'last_month') {
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                } else if (preset.label === 'Dün') {
                    start.setDate(today.getDate() - 1);
                    end.setDate(today.getDate() - 1);
                } else {
                    start.setDate(today.getDate() - preset.days + (preset.days === 0 ? 0 : 1));
                    if (preset.days > 1) start.setDate(today.getDate() - preset.days + 1);
                }

                if (preset.type !== 'all') {
                    this.start = start.toISOString().split('T')[0];
                    this.end = end.toISOString().split('T')[0];
                }

                // Update hidden inputs and submit
                this.$refs.startDate.value = this.start;
                this.$refs.endDate.value = this.end;
                this.$el.closest('form').submit();
            },
            applyCustom() {
                this.$refs.startDate.value = this.start;
                this.$refs.endDate.value = this.end;
                this.$el.closest('form').submit();
            }
        }" @click.away="isOpen = false">
            
            <!-- Hidden Inputs -->
            <input type="hidden" name="start_date" x-ref="startDate" value="{{ start_date|date:'Y-m-d'|default:'' }}">
            <input type="hidden" name="end_date" x-ref="endDate" value="{{ end_date|date:'Y-m-d'|default:'' }}">

            <!-- Trigger Button -->
            <button type="button" @click="isOpen = !isOpen"
                class="w-full flex items-center justify-between rounded-lg border border-gray-200 bg-white text-sm py-2 px-3 hover:bg-gray-50 focus:ring-1 focus:ring-primary focus:border-primary transition-colors">
                <span class="flex items-center gap-2 text-gray-700 truncate">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span x-text="label"></span>
                </span>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>

            <!-- Dropdown Panel -->
            <div x-show="isOpen" x-transition.origin.top.left
                class="absolute z-50 top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden">
                <div class="flex flex-col">
                    <!-- Presets -->
                    <div class="p-2 border-b border-gray-100 bg-gray-50/50 grid grid-cols-2 gap-1">
                        <template x-for="preset in presets">
                            <button type="button" @click="applyPreset(preset)"
                                class="text-left px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-white hover:text-primary hover:shadow-sm rounded-lg transition-all">
                                <span x-text="preset.label"></span>
                            </button>
                        </template>
                    </div>

                    <!-- Custom Range -->
                    <div class="p-3 space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Başlangıç</label>
                                <input type="date" x-model="start"
                                    class="w-full rounded-lg border-gray-200 text-xs py-1.5 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-[10px] font-semibold text-gray-400 uppercase mb-1">Bitiş</label>
                                <input type="date" x-model="end"
                                    class="w-full rounded-lg border-gray-200 text-xs py-1.5 px-2 focus:ring-1 focus:ring-primary focus:border-primary">
                            </div>
                        </div>
                        <button type="button" @click="applyCustom()"
                            class="w-full py-2 text-xs font-semibold text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors shadow-sm shadow-primary/30">
                            Uygula
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1"></div>

        <a href="{% url 'admin_reports_export' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" 
           class="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 rounded-lg text-sm font-medium transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Excel İndir
        </a>
    </form>
</div>

<div class="grid grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow border p-6">
        <h2 class="text-lg font-bold mb-4">Kampanya Bazlı Rapor</h2>
        <div class="space-y-2">
            {% for item in campaign_report %}
            <div class="flex justify-between p-3 bg-gray-50 rounded">
                <span class="text-sm font-medium">{{ item.campaign__title }}</span>
                <span class="text-sm font-bold">{{ item.order_count }} sipariş - ₺{{ item.total_revenue|floatformat:0 }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow border p-6">
        <h2 class="text-lg font-bold mb-4">Şehir Bazlı Rapor</h2>
        <div class="space-y-2">
            {% for item in city_report %}
            <div class="flex justify-between p-3 bg-gray-50 rounded">
                <span class="text-sm font-medium">{{ item.city_fk__name }}</span>
                <span class="text-sm font-bold">{{ item.order_count }} sipariş</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

